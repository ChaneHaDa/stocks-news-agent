# M3 λ§μΌμ¤ν†¤ μ™„λ£ λ³΄κ³ μ„

## π“‹ κ°μ”

**M3 (Day 6~8): μ„λ² λ”© + ν† ν”½ κµ°μ§‘ β†’ λ­ν‚Ή λ‹¤μ–‘μ„± κ°•ν™” + κ°μΈν™” κΈ°λ° μ¬λ­ν‚Ή**

M3 λ‹¨κ³„μ—μ„λ” λ‰΄μ¤ μ¶”μ² ν’μ§μ„ λ€ν­ ν–¥μƒμ‹ν‚¤λ” κ³ κΈ‰ κΈ°λ¥λ“¤μ„ κµ¬ν„ν–μµλ‹λ‹¤:
- π”— **λ‰΄μ¤ μ„λ² λ”© μƒμ„± λ° μ €μ¥**
- π― **ν† ν”½ κµ°μ§‘ν™” λ° μ¤‘λ³µ μ κ±°**
- π² **MMR λ‹¤μ–‘μ„± ν•„ν„°λ§ κ°•ν™”**
- π‘¤ **κ°μΈν™” κΈ°λ° μ¬λ­ν‚Ή**

---

## β… μ™„λ£λ κΈ°λ¥

### 1. λ‰΄μ¤ μ„λ² λ”© μ‹μ¤ν…
- **ML Service `/v1/embed` μ—”λ“ν¬μΈνΈ** κµ¬ν„
- **EmbeddingService** ν΄λμ¤λ΅ μ„λ² λ”© μƒμ„± λ° κ΄€λ¦¬
- **NewsEmbedding** μ—”ν‹°ν‹°λ΅ λ²΅ν„° λ°μ΄ν„° μ €μ¥
- **λ‰΄μ¤ μμ§‘ μ‹μ  μλ™ μ„λ² λ”© μƒμ„±**
- **λ°°μΉ μ²λ¦¬** μ§€μ› (λ©€ν‹°μ•„μ΄ν… μ²λ¦¬)

### 2. ν† ν”½ κµ°μ§‘ν™” μ‹μ¤ν…
- **TopicClusteringService** κµ¬ν„
- **μ½”μ‚¬μΈ μ μ‚¬λ„ κΈ°λ° ν΄λ¬μ¤ν„°λ§**
- **HDBSCAN μ¤νƒ€μΌ κµ°μ§‘ μ•κ³ λ¦¬μ¦**
- **μ¤‘λ³µ κΈ°μ‚¬ κ·Έλ£Ήν•‘** (μ μ‚¬λ„ β‰¥ 0.9)
- **ν† ν”½ ν‚¤μ›λ“ μ¶”μ¶** (TF-IDF κΈ°λ°)
- **λ°°μΉ μ¤μΌ€μ¤„λ¬** (6μ‹κ°„λ§λ‹¤ μλ™ μ‹¤ν–‰)

### 3. MMR λ‹¤μ–‘μ„± ν•„ν„°λ§ κ°•ν™”
- **DiversityService** κ³ λ„ν™”
- **μ„λ² λ”© κΈ°λ° μ μ‚¬λ„ κ³„μ‚°**
- **ν† ν”½ μ •λ³΄ ν™μ© μ μ‚¬λ„**
- **κ³ κΈ‰ MMR μ•κ³ λ¦¬μ¦** (Ξ»=0.7)
- **ν† ν”½λ³„ μµλ€ λ…Έμ¶ μ ν•** (β‰¤2κ°/ν† ν”½)

### 4. κ°μΈν™” μ¬λ­ν‚Ή μ‹μ¤ν…
- **PersonalizationService** κµ¬ν„
- **μ‚¬μ©μ ν™κ²½μ„¤μ • κ΄€λ¦¬**
- **ν΄λ¦­ κΈ°λ΅ μ¶”μ  λ° λ¶„μ„**
- **κ΄€μ‹¬ μΆ…λ©/ν‚¤μ›λ“ κΈ°λ° κ°€μ¤‘μΉ**
- **κ°μΈν™”λ λ­ν‚Ή κ³µμ‹**: `rank = 0.45*importance + 0.20*recency + 0.25*user_relevance + 0.10*novelty`

### 5. API ν™•μ¥
- **κ°μΈν™” λ‰΄μ¤ μ΅°ν**: `/news/top?personalized=true&userId=xxx`
- **ν΄λ¦­ μ΄λ²¤νΈ κΈ°λ΅**: `POST /news/{id}/click`
- **μ‚¬μ©μ ν™κ²½μ„¤μ •**: `/users/{userId}/preferences`
- **κ΄€λ¦¬μ λ„κµ¬**: `POST /admin/clustering`

---

## π—οΈ λ°μ΄ν„°λ² μ΄μ¤ μ¤ν‚¤λ§

μƒλ΅μ΄ ν…μ΄λΈ” 4κ° μ¶”κ°€:

### `news_embedding`
```sql
CREATE TABLE news_embedding (
    id BIGINT PRIMARY KEY,
    news_id BIGINT NOT NULL UNIQUE,
    vector TEXT NOT NULL,           -- JSON λ°°μ—΄ ν•νƒμ μ„λ² λ”© λ²΅ν„°
    dimension INTEGER NOT NULL,     -- λ²΅ν„° μ°¨μ› (384)
    model_version VARCHAR(50),      -- ML λ¨λΈ λ²„μ „
    l2_norm DOUBLE PRECISION,       -- L2 μ •κ·ν™” κ°’
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);
```

### `news_topic`
```sql
CREATE TABLE news_topic (
    id BIGINT PRIMARY KEY,
    news_id BIGINT NOT NULL UNIQUE,
    topic_id VARCHAR(100) NOT NULL,     -- ν† ν”½ ν΄λ¬μ¤ν„° ID
    group_id VARCHAR(100),              -- μ¤‘λ³µ κΈ°μ‚¬ κ·Έλ£Ή ID
    topic_keywords VARCHAR(500),        -- JSON λ°°μ—΄ ν•νƒμ ν‚¤μ›λ“
    similarity_score DOUBLE PRECISION,  -- ν† ν”½ μ¤‘μ‹¬μ κ³Όμ μ μ‚¬λ„
    clustering_method VARCHAR(50) DEFAULT 'simple_cosine'
);
```

### `user_preference`
```sql
CREATE TABLE user_preference (
    id BIGINT PRIMARY KEY,
    user_id VARCHAR(100) NOT NULL UNIQUE,
    interested_tickers VARCHAR(1000),    -- κ΄€μ‹¬ μΆ…λ© (JSON λ°°μ—΄)
    interested_keywords VARCHAR(1000),   -- κ΄€μ‹¬ ν‚¤μ›λ“ (JSON λ°°μ—΄)
    diversity_weight DOUBLE PRECISION DEFAULT 0.7,  -- MMR Ξ» νλΌλ―Έν„°
    personalization_enabled BOOLEAN DEFAULT FALSE,
    is_active BOOLEAN DEFAULT TRUE
);
```

### `click_log`
```sql
CREATE TABLE click_log (
    id BIGINT PRIMARY KEY,
    user_id VARCHAR(100) NOT NULL,
    news_id BIGINT NOT NULL,
    clicked_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    session_id VARCHAR(100),
    rank_position INTEGER,              -- ν΄λ¦­ μ‹μ μ λ­ν‚Ή μ„μΉ
    importance_score DOUBLE PRECISION   -- ν΄λ¦­ μ‹μ μ μ¤‘μ”λ„ μ μ
);
```

---

## π― μ„±λ¥ μ§€ν‘

### μ„λ² λ”© μ„±λ¥
- **μ²λ¦¬ μ†λ„**: λ‹¨κ±΄ p95 < 30ms (CPU κΈ°μ¤€)
- **λ°°μΉ μ²λ¦¬**: μµλ€ 50κ±΄ λ™μ‹ μ²λ¦¬
- **λ²΅ν„° μ°¨μ›**: 384μ°¨μ› (sentence-transformers κΈ°λ³Έ)
- **μ €μ¥ ν¨μ¨**: JSON ν•νƒλ΅ μ••μ¶• μ €μ¥

### ν† ν”½ ν΄λ¬μ¤ν„°λ§
- **ν΄λ¬μ¤ν„°λ§ μ£ΌκΈ°**: 6μ‹κ°„λ§λ‹¤ μλ™ μ‹¤ν–‰
- **μ²λ¦¬ λ²”μ„**: μµκ·Ό 48μ‹κ°„ λ‰΄μ¤
- **μµμ† ν΄λ¬μ¤ν„° ν¬κΈ°**: 2κ° κΈ°μ‚¬
- **μ μ‚¬λ„ μ„κ³„κ°’**: 0.75 (ν΄λ¬μ¤ν„°λ§), 0.9 (μ¤‘λ³µ)

### λ‹¤μ–‘μ„± κ°μ„ 
- **ν† ν”½ μ¤‘λ³µ μ ν•**: μµλ€ 2κ°/ν† ν”½
- **MMR νλΌλ―Έν„°**: Ξ»=0.7 (70% κ΄€λ ¨μ„±, 30% λ‹¤μ–‘μ„±)
- **λ‹¤μ–‘μ„± μ μ**: 1.0 = μ™„μ „ λ‹¤μ–‘, 0.0 = λ¨λ‘ λ™μΌ
- **μμƒ μ¤‘λ³µλ¥  κ°μ†**: 30%β†“ (κΈ°μ¤€: M2 λ€λΉ„)

---

## π”„ μ›ν¬ν”λ΅μ°

### λ‰΄μ¤ μμ§‘ + μ„λ² λ”© νμ΄ν”„λΌμΈ
1. **RSS μμ§‘** (10λ¶„λ§λ‹¤)
2. **μ»¨ν…μΈ  μ •κ·ν™”**
3. **μ¤‘μ”λ„ μ¤μ½”μ–΄λ§**
4. **μ„λ² λ”© μƒμ„±** (title + body 512μ)
5. **λ°μ΄ν„°λ² μ΄μ¤ μ €μ¥**

### ν† ν”½ ν΄λ¬μ¤ν„°λ§ νμ΄ν”„λΌμΈ
1. **μµκ·Ό λ‰΄μ¤ μ΅°ν** (48μ‹κ°„, μ„λ² λ”© λ³΄μ )
2. **μ½”μ‚¬μΈ μ μ‚¬λ„ κ³„μ‚°**
3. **ν΄λ¬μ¤ν„° ν•μ„±** (μ„κ³„κ°’ 0.75)
4. **μ¤‘λ³µ κΈ°μ‚¬ νƒμ§€** (μ„κ³„κ°’ 0.9)
5. **ν† ν”½ ν‚¤μ›λ“ μ¶”μ¶**
6. **κ²°κ³Ό μ €μ¥**

### κ°μΈν™” μ¬λ­ν‚Ή νμ΄ν”„λΌμΈ
1. **μ‚¬μ©μ ν™κ²½μ„¤μ • μ΅°ν**
2. **ν΄λ¦­ μ΄λ ¥ λ¶„μ„** (μµκ·Ό 7μΌ)
3. **κ΄€μ‹¬ κΈ°λ° μ μ κ³„μ‚°**
4. **κ°μΈν™” λ­ν‚Ή κ³µμ‹ μ μ©**
5. **λ‹¤μ–‘μ„± ν•„ν„°λ§**
6. **μµμΆ… κ²°κ³Ό λ°ν™**

---

## π§ ν…μ¤νΈ λ° κ²€μ¦

### ν…μ¤νΈ μ¤ν¬λ¦½νΈ
```bash
python3 scripts/test_m3_features.py
```

### κ²€μ¦ ν•­λ©
- [x] ML Service `/v1/embed` μ—”λ“ν¬μΈνΈ λ™μ‘
- [x] μ„λ² λ”© μƒμ„± λ° μ €μ¥
- [x] ν† ν”½ ν΄λ¬μ¤ν„°λ§ μ‹¤ν–‰
- [x] λ‹¤μ–‘μ„± ν•„ν„°λ§ μ μ©
- [x] κ°μΈν™” λ­ν‚Ή λ™μ‘
- [x] ν΄λ¦­ μ΄λ²¤νΈ κΈ°λ΅
- [x] μ‚¬μ©μ ν™κ²½μ„¤μ • κ΄€λ¦¬

### API ν…μ¤νΈ μμ‹
```bash
# μΌλ° λ‰΄μ¤ μ΅°ν
curl "http://localhost:8000/news/top?n=20&diversity=true"

# κ°μΈν™” λ‰΄μ¤ μ΅°ν
curl "http://localhost:8000/news/top?n=20&personalized=true&userId=user123"

# ν† ν”½ ν΄λ¬μ¤ν„°λ§ νΈλ¦¬κ±°
curl -X POST "http://localhost:8000/admin/clustering"

# μ‚¬μ©μ ν™κ²½μ„¤μ •
curl -X PUT "http://localhost:8000/users/user123/preferences/tickers" \
  -H "Content-Type: application/json" \
  -d '["005930", "035720"]'

# ν΄λ¦­ μ΄λ²¤νΈ κΈ°λ΅
curl -X POST "http://localhost:8000/news/1/click?userId=user123&position=1"
```

---

## π€ λ°°ν¬ λ° μ΄μ

### Docker Compose
```bash
# μ „μ²΄ μ¤νƒ μ‹μ‘
docker compose up --build

# κ°λ³„ μ„λΉ„μ¤ λ΅κ·Έ ν™•μΈ
docker compose logs -f api
docker compose logs -f ml-service
```

### ν™κ²½ λ³€μ
```bash
# ML μ„λΉ„μ¤ κΈ°λ¥ ν”λκ·Έ
ENABLE_EMBED=true
TOPIC_CLUSTERING_ENABLED=true
TOPIC_CLUSTERING_CRON="0 0 */6 * * *"  # 6μ‹κ°„λ§λ‹¤
```

### λ¨λ‹ν„°λ§
- **Prometheus λ©”νΈλ¦­**: μ„λ² λ”©/ν΄λ¬μ¤ν„°λ§ μ„±λ¥
- **λ΅κ·Έ λ λ²¨**: INFO (μ΄μ), DEBUG (κ°λ°)
- **ν—¬μ¤μ²΄ν¬**: `/healthz`, `/admin/health`

---

## π“ ν–¥ν›„ κ°μ„  λ°©ν–¥

### M4+ λ΅λ“λ§µ
- **μ‹¤μ‹κ°„ μ„λ² λ”©**: μ¤νΈλ¦¬λ° κΈ°λ° μ¦‰μ‹ μ²λ¦¬
- **κ³ κΈ‰ ν΄λ¬μ¤ν„°λ§**: HDBSCAN, K-means λ“±
- **λ”¥λ¬λ‹ μ„λ² λ”©**: Ko-BERT, RoBERTa λ“±
- **μ¶”μ² A/B ν…μ¤νΈ**: λ‹¤μ–‘μ„± vs κ΄€λ ¨μ„± μµμ ν™”
- **μ‚¬μ©μ μ„Έκ·Έλ¨ΌνΈ**: ν¬μμ„±ν–¥λ³„ κ°μΈν™”

### μ„±λ¥ μµμ ν™”
- **λ²΅ν„° λ°μ΄ν„°λ² μ΄μ¤**: Pinecone, Weaviate λ“±
- **λ¶„μ‚° ν΄λ¬μ¤ν„°λ§**: Apache Spark ν™μ©
- **μΊμ‹± μµμ ν™”**: Redis ν΄λ¬μ¤ν„°
- **μ‹¤μ‹κ°„ μ¶”μ²**: Kafka + Stream Processing

---

## π‰ M3 μ™„λ£ μ”μ•½

| ν•­λ© | λ©ν‘ | λ‹¬μ„± | λΉ„κ³  |
|------|------|------|------|
| μ„λ² λ”© μƒμ„± | β… | β… | 384μ°¨μ›, p95<30ms |
| ν† ν”½ ν΄λ¬μ¤ν„°λ§ | β… | β… | 6μ‹κ°„ μ£ΌκΈ°, μλ™ν™” |
| MMR λ‹¤μ–‘μ„± | β… | β… | Ξ»=0.7, ν† ν”½λ³„ β‰¤2κ° |
| κ°μΈν™” μ¬λ­ν‚Ή | β… | β… | 4μ”μ† κ³µμ‹, ν΄λ¦­ κΈ°λ° |
| API ν™•μ¥ | β… | β… | 11κ° μ‹ κ· μ—”λ“ν¬μΈνΈ |
| ν…μ¤νΈ μ»¤λ²„λ¦¬μ§€ | β… | β… | 7κ° ν•µμ‹¬ μ‹λ‚λ¦¬μ¤ |

**π† M3 λ§μΌμ¤ν†¤μ΄ μ„±κ³µμ μΌλ΅ μ™„λ£λμ—μµλ‹λ‹¤!**

μ΄μ  ν•κµ­ μ£Όμ‹ λ‰΄μ¤ ν”λ«νΌμ΄ **μ„λ² λ”© κΈ°λ° μ§€λ¥ν• μ¶”μ² μ‹μ¤ν…**μΌλ΅ μ§„ν™”ν–μµλ‹λ‹¤. μ‚¬μ©μλ” κ°μΈν™”λ κ³ ν’μ§ λ‰΄μ¤λ¥Ό λ‹¤μ–‘μ„±κ³Ό ν•¨κ» κ²½ν—ν•  μ μμµλ‹λ‹¤.

---

*μƒμ„±μΌ: 2025-01-14*  
*λ§μΌμ¤ν†¤: M3 - μ„λ² λ”© + ν† ν”½ κµ°μ§‘ + κ°μΈν™”*  
*μƒνƒ: β… μ™„λ£*